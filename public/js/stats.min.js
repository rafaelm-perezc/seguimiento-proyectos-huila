document.addEventListener('DOMContentLoaded',()=>{const lblTotalProyectos=document.getElementById('lblTotalProyectos');const lblTotalInversion=document.getElementById('lblTotalInversion');const lblTotalSedes=document.getElementById('lblTotalSedes');const lblPromedioAvance=document.getElementById('lblPromedioAvance');const filtroMunicipio=document.getElementById('filtroMunicipio');const filtroProyecto=document.getElementById('filtroProyecto');const filtroIndicador=document.getElementById('filtroIndicador');const btnLimpiar=document.getElementById('btnLimpiarFiltros');let evolutionChart=null;let distributionChart=null;init();function init(){loadGeneralStats();loadFilters();updateCharts();}async function loadGeneralStats(){try{const res=await fetch('/api/stats/general');const data=await res.json();lblTotalProyectos.textContent=data.total_proyectos;lblTotalInversion.textContent=new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(data.total_inversion);lblTotalSedes.textContent=data.total_sedes;lblPromedioAvance.textContent=(data.promedio_avance_global||0).toFixed(1)+'%';}catch(error){console.error("Error cargando estadísticas generales:",error);}}async function loadFilters(){try{const resMun=await fetch('/api/municipios');const dataMun=await resMun.json();dataMun.forEach(m=>filtroMunicipio.add(new Option(m.nombre,m.id)));const resInd=await fetch('/api/indicadores');const dataInd=await resInd.json();dataInd.forEach(i=>filtroIndicador.add(new Option(i.nombre,i.id)));}catch(error){console.error("Error cargando filtros:",error);}}filtroMunicipio.addEventListener('change',updateCharts);filtroProyecto.addEventListener('change',updateCharts);filtroIndicador.addEventListener('change',updateCharts);btnLimpiar.addEventListener('click',()=>{filtroMunicipio.value="";filtroProyecto.value="";filtroIndicador.value="";updateCharts();});async function updateCharts(){const params=new URLSearchParams({municipio_id:filtroMunicipio.value,indicador_id:filtroIndicador.value});try{const resEvo=await fetch(`/api/stats/evolution?${params}`);const dataEvo=await resEvo.json();const labels=dataEvo.map(d=>d.fecha_seguimiento);const values=dataEvo.map(d=>d.avance_promedio);const ctxEvo=document.getElementById('chartEvolution').getContext('2d');if(evolutionChart)evolutionChart.destroy();evolutionChart=new Chart(ctxEvo,{type:'line',data:{labels:labels,datasets:[{label:'% Avance Promedio',data:values,borderColor:'#005f27',backgroundColor:'rgba(0, 95, 39, 0.1)',borderWidth:3,tension:0.3,fill:true,pointRadius:5,pointHoverRadius:8}]},options:{responsive:true,scales:{y:{beginAtZero:true,max:100,title:{display:true,text:'% Porcentaje'}},x:{title:{display:true,text:'Fecha de Seguimiento'}}},plugins:{tooltip:{callbacks:{label:(ctx)=>ctx.raw.toFixed(2)+'%'}}}}});const ctxDist=document.getElementById('chartDistribution').getContext('2d');if(distributionChart)distributionChart.destroy();distributionChart=new Chart(ctxDist,{type:'bar',data:{labels:['R.P.','S.G.P.','MEN','S.G.R.'],datasets:[{label:'Fuentes de Inversión (Simulado)',data:[45,25,20,10],backgroundColor:['#e67e22','#2980b9','#8e44ad','#27ae60']}]},options:{responsive:true,plugins:{legend:{display:false},title:{display:true,text:'Distribución de Recursos (Ejemplo)'}}}});}catch(error){console.error("Error dibujando gráficas:",error);}}});